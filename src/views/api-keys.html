<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API Keys - Finance Tracker</title>
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="/js/static.js"></script>
    <style>
        .code-block {
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: var(--border-radius);
            font-family: monospace;
            overflow-x: auto;
            margin: 1rem 0;
        }

        .code-block pre {
            margin: 0;
        }

        .key-value {
            font-family: monospace;
            padding: 0.5rem;
            background: #f1f5f9;
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 0.5rem 0;
        }

        .copy-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0.25rem 0.5rem;
        }

        .copy-btn:hover {
            color: var(--secondary-color);
        }

        .documentation {
            margin-top: 2rem;
        }

        .endpoint {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
        }

        .method {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: var(--border-radius);
            font-weight: 500;
            margin-right: 0.5rem;
        }

        .method.post {
            background: #22c55e;
            color: white;
        }

        .param-table {
            margin: 1rem 0;
        }

        .method.get {
            background: #22c55e;
            color: white;
        }

        .code-block {
            margin: 1rem 0;
            background: #1e293b;
            color: #e2e8f0;
            padding: 1rem;
            border-radius: var(--border-radius);
            font-family: monospace;
            overflow-x: auto;
        }

        .code-block pre {
            margin: 0;
            white-space: pre-wrap;
        }

        .param-table {
            width: 100%;
            margin: 1rem 0;
            border-collapse: collapse;
        }

        .param-table th,
        .param-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }

        .param-table th {
            background: #f8fafc;
            font-weight: 600;
        }

        .endpoint {
            border-left: 4px solid var(--primary-color);
            padding-left: 1rem;
            margin: 1rem 0;
        }

        .endpoint h4 {
            margin-bottom: 0.5rem;
        }

        .endpoint h5 {
            margin: 1.5rem 0 0.5rem 0;
            color: var(--text-color);
        }

        .feature-list {
            list-style: none;
            padding: 0;
            margin: 1rem 0;
        }

        .feature-list li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .feature-list li:before {
            content: "✓";
            color: var(--primary-color);
            position: absolute;
            left: 0;
        }
    </style>
</head>

<body>
    <div class="main-content">
        <!-- API Keys Management -->
        <div class="card">
            <div class="card-header">
                <h3 class="card-title">API Keys</h3>
                <button class="btn btn-primary" id="generateKeyBtn">
                    <i class="fas fa-plus"></i> Generate New Key
                </button>
            </div>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Created</th>
                            <th>Last Used</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="apiKeysTable"></tbody>
                </table>
            </div>
        </div>

        <!-- API Documentation -->
        <div class="card documentation">
            <div class="card-header">
                <h3 class="card-title">API Documentation</h3>
            </div>

            <div class="endpoint">
                <h4>Add Transaction</h4>
                <p><span class="method get">GET</span> /api/v1/add-transaction</p>
                <p>Add a new transaction to your account using a simple GET request.</p>

                <div class="code-block">
                    <pre>curl "https://your-domain.com/api/v1/add-transaction?key=YOUR_API_KEY&type=expense&amount=42.99&description=Grocery+shopping&category_id=1"</pre>
                </div>

                <h5>Query Parameters</h5>
                <table class="param-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>key</td>
                            <td>string</td>
                            <td>Yes</td>
                            <td>Your API key</td>
                        </tr>
                        <tr>
                            <td>type</td>
                            <td>string</td>
                            <td>Yes</td>
                            <td>"income" or "expense"</td>
                        </tr>
                        <tr>
                            <td>amount</td>
                            <td>number</td>
                            <td>Yes</td>
                            <td>Transaction amount</td>
                        </tr>
                        <tr>
                            <td>description</td>
                            <td>string</td>
                            <td>Yes</td>
                            <td>Transaction description</td>
                        </tr>
                        <tr>
                            <td>category_id</td>
                            <td>number</td>
                            <td>No</td>
                            <td>Category ID (optional)</td>
                        </tr>
                    </tbody>
                </table>

                <h5>Example Usage</h5>
                <div class="code-block">
                    <pre># Python
import requests

url = "https://your-domain.com/api/v1/add-transaction"
params = {
    "key": "YOUR_API_KEY",
    "type": "expense",
    "amount": 42.99,
    "description": "Grocery shopping",
    "category_id": 1
}

response = requests.get(url, params=params)
print(response.json())</pre>
                </div>

                <div class="code-block">
                    <pre># JavaScript/Node.js
const url = new URL('https://your-domain.com/api/v1/add-transaction');
url.searchParams.append('key', 'YOUR_API_KEY');
url.searchParams.append('type', 'expense');
url.searchParams.append('amount', '42.99');
url.searchParams.append('description', 'Grocery shopping');
url.searchParams.append('category_id', '1');

fetch(url)
    .then(response => response.json())
    .then(data => console.log(data));</pre>
                </div>

                <div class="code-block">
                    <pre># Shell Script
#!/bin/bash
API_KEY="YOUR_API_KEY"
AMOUNT="42.99"
DESC="Grocery shopping"
TYPE="expense"
CATEGORY="1"

curl -G "https://your-domain.com/api/v1/add-transaction" \
    --data-urlencode "key=$API_KEY" \
    --data-urlencode "amount=$AMOUNT" \
    --data-urlencode "description=$DESC" \
    --data-urlencode "type=$TYPE" \
    --data-urlencode "category_id=$CATEGORY"</pre>
                </div>

                <h5>Response</h5>
                <div class="code-block">
                    <pre>{
    "id": 123,
    "user_id": 456,
    "amount": 42.99,
    "description": "Grocery shopping",
    "category_id": 1,
    "type": "expense",
    "date": "2024-01-09T12:34:56Z",
    "created_at": "2024-01-09T12:34:56Z"
}</pre>
                </div>

                <h5>Error Responses</h5>
                <table class="param-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>400</td>
                            <td>Missing required parameters</td>
                        </tr>
                        <tr>
                            <td>401</td>
                            <td>Invalid or missing API key</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>Server error</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="endpoint">
                <h4>Parse Transaction from Notification</h4>
                <p><span class="method get">GET</span> /api/v1/parse-transaction</p>
                <p>Add a transaction by providing a bank notification text. GPT-4 will automatically extract the
                    transaction details.</p>

                <div class="code-block">
                    <pre>curl "https://your-domain.com/api/v1/parse-transaction?key=YOUR_API_KEY&text=Payment+of+EUR+42.99+to+ALBERT+HEIJN+on+your+debit+card"</pre>
                </div>

                <h5>Query Parameters</h5>
                <table class="param-table">
                    <thead>
                        <tr>
                            <th>Parameter</th>
                            <th>Type</th>
                            <th>Required</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>key</td>
                            <td>string</td>
                            <td>Yes</td>
                            <td>Your API key</td>
                        </tr>
                        <tr>
                            <td>text</td>
                            <td>string</td>
                            <td>Yes</td>
                            <td>The bank notification text to parse</td>
                        </tr>
                    </tbody>
                </table>

                <h5>Example Usage</h5>
                <div class="code-block">
                    <pre># Python
import requests

url = "https://your-domain.com/api/v1/parse-transaction"
params = {
    "key": "YOUR_API_KEY",
    "text": "Payment of EUR 42.99 to ALBERT HEIJN on your debit card"
}

response = requests.get(url, params=params)
print(response.json())</pre>
                </div>

                <div class="code-block">
                    <pre># JavaScript/Node.js
const url = new URL('https://your-domain.com/api/v1/parse-transaction');
url.searchParams.append('key', 'YOUR_API_KEY');
url.searchParams.append('text', 'Payment of EUR 42.99 to ALBERT HEIJN on your debit card');

fetch(url)
    .then(response => response.json())
    .then(data => console.log(data));</pre>
                </div>

                <h5>Example Bank Notification Formats</h5>
                <div class="code-block">
                    <pre># The AI can understand various notification formats and currencies:

"Payment of EUR 42.99 to ALBERT HEIJN on your debit card"
"Received transfer of €1,234.56 from COMPANY NAME - Salary January"
"Card purchase: $25.50 at SHELL STATION"
"Direct debit: Netflix EUR 15.99"
"ATM withdrawal: GBP 100.00"
"Purchase: ¥5000 at TOKYO RESTAURANT"
"Payment received: CHF 150 - Freelance work"</pre>
                </div>

                <h5>Currency Handling</h5>
                <p>The API automatically handles currency conversion based on your account settings:</p>
                <ul class="feature-list">
                    <li>Detects the original currency from the notification</li>
                    <li>Converts to your preferred account currency</li>
                    <li>Uses real-time exchange rates</li>
                    <li>Stores the transaction in your preferred currency</li>
                </ul>

                <h5>Response</h5>
                <div class="code-block">
                    <pre>{
    "message": "Transaction added successfully",
    "parsed_data": {
        "amount": 42.99,
        "currency": "EUR",          // Original currency from notification
        "type": "expense",
        "description": "ALBERT HEIJN",
        "category_id": 7,           // Food category
        "original_amount": 42.99,   // Amount in original currency
        "original_currency": "EUR", // Original currency
        "converted_amount": 46.50,  // Amount in user's currency
        "user_currency": "USD"      // User's preferred currency
    },
    "transaction": {
        "id": 123,
        "user_id": 456,
        "amount": 46.50,           // Stored in user's preferred currency
        "description": "ALBERT HEIJN",
        "category_id": 7,
        "type": "expense",
        "date": "2024-01-09T12:34:56Z",
        "created_at": "2024-01-09T12:34:56Z"
    }
}</pre>
                </div>

                <h5>Error Responses</h5>
                <table class="param-table">
                    <thead>
                        <tr>
                            <th>Status</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>400</td>
                            <td>Missing API key or notification text</td>
                        </tr>
                        <tr>
                            <td>401</td>
                            <td>Invalid or missing API key</td>
                        </tr>
                        <tr>
                            <td>500</td>
                            <td>Server error or parsing failed</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Generate API Key Modal -->
    <div id="apiKeyModal" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Generate API Key</h3>
                <button class="close-modal" id="closeModalBtn">&times;</button>
            </div>
            <form id="apiKeyForm">
                <div class="form-group">
                    <label class="form-label">Key Name</label>
                    <input type="text" class="form-control" name="name" required
                        placeholder="e.g., Development, Production">
                </div>
                <button type="submit" class="btn btn-primary">Generate Key</button>
            </form>
        </div>
    </div>

    <script>
        // Load API keys
        async function loadApiKeys() {
            try {
                const response = await fetch('/api/keys', {
                    credentials: 'include'
                });
                const keys = await response.json();

                const tbody = document.getElementById('apiKeysTable');
                tbody.innerHTML = keys.map(key => {
                    const revokeBtn = document.createElement('button');
                    revokeBtn.className = 'btn btn-secondary btn-sm';
                    revokeBtn.dataset.keyId = key.id;
                    revokeBtn.innerHTML = '<i class="fas fa-trash"></i> Revoke';

                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${key.name}</td>
                        <td>${new Date(key.created_at).toLocaleDateString()}</td>
                        <td>${key.last_used ? new Date(key.last_used).toLocaleDateString() : 'Never'}</td>
                        <td>
                            <span class="badge ${key.is_active ? 'badge-success' : 'badge-error'}">
                                ${key.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td></td>
                    `;
                    tr.querySelector('td:last-child').appendChild(revokeBtn);
                    return tr.outerHTML;
                }).join('');

                // Add event listeners to revoke buttons
                document.querySelectorAll('.btn-secondary[data-key-id]').forEach(btn => {
                    btn.addEventListener('click', () => revokeApiKey(btn.dataset.keyId));
                });
            } catch (err) {
                console.error('Failed to load API keys:', err);
            }
        }

        // Generate new API key
        function openApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'flex';
            document.getElementById('apiKeyForm').reset();
        }

        function closeApiKeyModal() {
            document.getElementById('apiKeyModal').style.display = 'none';
        }

        // Copy to clipboard utility
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('API key copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy text:', err);
            });
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();

            // Generate Key button
            document.getElementById('generateKeyBtn').addEventListener('click', openApiKeyModal);

            // Close modal button
            document.getElementById('closeModalBtn').addEventListener('click', closeApiKeyModal);

            // Form submission
            document.getElementById('apiKeyForm').addEventListener('submit', async (event) => {
                event.preventDefault();
                const formData = new FormData(event.target);
                const data = Object.fromEntries(formData.entries());

                try {
                    const response = await fetch('/api/keys', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify(data)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        closeApiKeyModal();

                        // Show the new key to the user
                        const modal = document.createElement('div');
                        modal.className = 'modal-overlay';
                        modal.style.display = 'flex';

                        const keyValue = result.key_value;
                        modal.innerHTML = `
                            <div class="modal">
                                <div class="modal-header">
                                    <h3 class="modal-title">Your New API Key</h3>
                                    <button class="close-modal" id="closeKeyModal">&times;</button>
                                </div>
                                <p>Please copy your API key now. You won't be able to see it again!</p>
                                <div class="key-value">
                                    <span>${keyValue}</span>
                                    <button class="copy-btn" id="copyKeyBtn">
                                        <i class="fas fa-copy"></i>
                                    </button>
                                </div>
                            </div>
                        `;

                        document.body.appendChild(modal);

                        // Add event listeners for the new modal
                        modal.querySelector('#closeKeyModal').addEventListener('click', () => modal.remove());
                        modal.querySelector('#copyKeyBtn').addEventListener('click', () => copyToClipboard(keyValue));

                        loadApiKeys();
                    } else {
                        throw new Error('Failed to generate API key');
                    }
                } catch (err) {
                    console.error('Error generating API key:', err);
                    alert('Failed to generate API key. Please try again.');
                }
            });
        });

        // Revoke API key
        async function revokeApiKey(id) {
            if (!confirm('Are you sure you want to revoke this API key? This action cannot be undone.')) return;

            try {
                const response = await fetch(`/api/keys/${id}`, {
                    method: 'DELETE',
                    credentials: 'include'
                });

                if (response.ok) {
                    loadApiKeys();
                } else {
                    throw new Error('Failed to revoke API key');
                }
            } catch (err) {
                console.error('Error revoking API key:', err);
                alert('Failed to revoke API key. Please try again.');
            }
        }
    </script>
</body>

</html>